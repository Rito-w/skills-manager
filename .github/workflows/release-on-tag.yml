name: Release on Tag

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-mac:
    strategy:
      matrix:
        include:
          - os: macos-13
            arch: x64
          - os: macos-14
            arch: arm64
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: "10"
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
          cache-dependency-path: "pnpm-lock.yaml"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build macOS app
        run: pnpm tauri build

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mac-artifacts-${{ matrix.arch }}
          path: |
            src-tauri/target/release/bundle/dmg/*.dmg
            src-tauri/target/release/bundle/macos/*.app
          if-no-files-found: error

  build-win:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: "10"
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
          cache-dependency-path: "pnpm-lock.yaml"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Windows app
        run: pnpm tauri build

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: win-artifacts
          path: |
            src-tauri/target/release/bundle/msi/*.msi
            src-tauri/target/release/bundle/nsis/*.exe
          if-no-files-found: error

  release:
    needs: [build-mac, build-win]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}

      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: mac-artifacts-*
          merge-multiple: true
          path: artifacts

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: win-artifacts
          path: artifacts

      - name: Extract Changelog
        id: extract_changelog
        run: |
          CHANGELOG_CONTENT=$(node .github/scripts/extract-changelog.js)
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG_CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          draft: false
          prerelease: false
          files: |
            artifacts/**/skills-manager-gui*.dmg
            artifacts/**/skills-manager-gui*.msi
            artifacts/**/skills-manager-gui*.exe
          body: |
            ## ğŸ‰ æ–°ç‰ˆæœ¬å‘å¸ƒï¼

            **æ³¨æ„ï¼šæœ¬é¡¹ç›®æš‚æ— å•†ä¸šç­¾åè¯ä¹¦ï¼Œå®‰è£…æ—¶å¯èƒ½ä¼šæç¤ºå®‰å…¨è­¦å‘Šã€‚**

            ### ğŸ macOS ç”¨æˆ·
            åˆæ¬¡å®‰è£…å¯èƒ½å‡ºç° â€œåº”ç”¨å·²æŸåï¼Œæ— æ³•æ‰“å¼€â€ æˆ– â€œæ¥è‡ªèº«ä»½ä¸æ˜çš„å¼€å‘è€…â€ã€‚

            è¯·æ‰“å¼€ã€Œç»ˆç«¯ã€æ‰§è¡Œï¼š

            ```bash
            xattr -cr /Applications/skills-manager-gui.app
            ```

            ### ğŸªŸ Windows ç”¨æˆ·
            å¦‚æœå‡ºç° SmartScreen æç¤ºï¼š

            1. ç‚¹å‡» â€œæ›´å¤šä¿¡æ¯â€
            2. ç‚¹å‡» â€œä»è¦è¿è¡Œâ€

            ---

            ### æ›´æ–°æ—¥å¿—
            ${{ steps.extract_changelog.outputs.notes }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
